generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TokenType {
  REFRESH
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum WalletType {
  CASH
  DEBIT_CARD
  CREDIT_CARD
  SAVINGS
  CUSTOM
}

model User {
  id                 String   @id @default(uuid()) @db.Uuid
  email              String   @unique
  firstName          String
  lastName           String
  password           String
  avatarUrl          String?

  totalBalance       Int      @default(0)

  isTwoFactorEnabled Boolean  @default(false)
  twoFactorCode      String?
  twoFactorExpiresAt DateTime?

  mainCurrencyCode   String   @default("USD") @map("main_currency_code") @db.VarChar(3)
  mainCurrency       Currency @relation(fields: [mainCurrencyCode], references: [code])

  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  tokens             Token[]
  transactions       Transaction[]
  dailySnapshots     DailyBalanceSnapshot[]
  favoriteCurrencies UserFavoriteCurrency[]
  favoriteCategories UserFavoriteCategory[]
  wallets            Wallet[]

  @@map("users")
}

model Token {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  token     String    @unique
  type      TokenType

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("tokens")
}

model Transaction {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String    @map("user_id") @db.Uuid

  amount       Int       @default(0)
  date         DateTime
  description  String?

  categoryId   String    @map("category_id") @db.Uuid
  category     Category  @relation(fields: [categoryId], references: [id])
  type         TransactionType

  walletId     String    @map("wallet_id") @db.Uuid
  wallet       Wallet    @relation(fields: [walletId], references: [id])

  currencyCode String    @default("USD") @map("currency_code") @db.VarChar(3)
  currency     Currency @relation(fields: [currencyCode], references: [code])

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([walletId])
  @@map("transactions")
}

model Wallet {
  id             String     @id @default(uuid()) @db.Uuid
  userId         String     @map("user_id") @db.Uuid
  name           String
  type           WalletType @default(CASH)
  
  currencyCode   String     @map("currency_code") @db.VarChar(3)
  currency       Currency   @relation(fields: [currencyCode], references: [code])
  
  initialBalance Int        @default(0) @map("initial_balance")
  isDefault      Boolean    @default(false) @map("is_default")
  isArchived     Boolean    @default(false) @map("is_archived")

  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions   Transaction[]

  @@unique([userId, name])
  @@index([userId])
  @@map("wallets")
}

model DailyBalanceSnapshot {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  date            DateTime @db.Date

  openingBalance  Int
  closingBalance  Int

  currencyCode    String   @map("currency_code") @db.VarChar(3)
  currency        Currency @relation(fields: [currencyCode], references: [code])

  totalIncome     Int      @default(0)
  totalExpense    Int      @default(0)
  netChange       Int      @default(0)

  incomeCount     Int      @default(0)
  expenseCount    Int      @default(0)

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
  @@map("daily_balance_snapshots")
}

model Currency {
  code   String @id @db.VarChar(3)
  name   String

  users                 User[]
  transactions          Transaction[]
  dailyBalanceSnapshots DailyBalanceSnapshot[]
  favoritedBy           UserFavoriteCurrency[]
  wallets               Wallet[]

  @@map("currencies")
}

model UserFavoriteCurrency {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  currencyCode String   @map("currency_code") @db.VarChar(3)

  order        Int      @default(0)

  createdAt    DateTime @default(now()) @map("created_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  currency Currency @relation(fields: [currencyCode], references: [code], onDelete: Cascade)

  @@unique([userId, currencyCode])
  @@index([userId])
  @@map("user_favorite_currencies")
}

model Category {
  id     String       @id @default(uuid()) @db.Uuid
  name   String       @unique
  color  String
  type   TransactionType
  order  Int          @default(0)

  transactions   Transaction[]
  favoritedBy    UserFavoriteCategory[]

  @@map("categories")
}

model UserFavoriteCategory {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  categoryId String   @map("category_id") @db.Uuid

  order      Int      @default(0)

  createdAt  DateTime @default(now()) @map("created_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@index([userId])
  @@map("user_favorite_categories")
}
